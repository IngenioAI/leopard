<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Leopard</title>
    <LP-include-html src="head.html"></LP-include-html>
    <script src="/js/control/list_group.js"></script>
    <script src="/js/control/tab.js"></script>
    <script>
      let sourceUploadInfo = null;
      let currentLog = null;
      let logWindow = null;

      function createExecItem(itemInfo, execInfo) {
        return createListGroupItem(
          [
            { name: "h5", attributes: { class: "mb-1" }, children: [
              { name: "span", attributes: { class: "", style: "padding-right: 0.2em" } },
              { name: "span", text: itemInfo.id }
            ]},
            { name: "div", attributes: { class: "d-flex w-100 justify-content-between" }, children: [
              { name: "small", text: itemInfo.command },
              { name: "small", text: itemInfo.imageTag }
            ]},
            { name: "div", text: "running", attributes: { id: `state_${itemInfo.id}`} }
          ],
          (e) => {
            logWindow = showLogView(`${itemInfo.command} on ${itemInfo.imageTag}`, `실행 로그 - ${itemInfo.id}`);
            if (currentLog) {
              logWindow.setLog(currentLog);
            }
          });
      }

      async function createExecution() {
        const item = createPostItem([
          ["id", "input_exp_id"],
          ['srcPath', 'src_path'],
          ['command', 'command_line'],
          ['imageTag', 'select_images'],
          ['inputPath', 'input_data_path'],
          ['outputPath', 'output_data_path']
        ]);
        if (item["id"] == "") {
          showMessageBox("실험 ID를 입력해야 합니다.", "실행");
          return;
        }
        if (sourceUploadInfo && sourceUploadInfo.success) {
          item['uploadId'] = sourceUploadInfo.upload_id;
        }
        const execInfo = await createExec(item);
        execInfo.id = item['id'];
        setTimeout(checkLogs, 1000, execInfo);

        const elem = getE("exec_list");
        addE(elem, createExecItem(item, execInfo));
        showTab("current_exec");
      }

      async function checkLogs(info) {
        const inspectInfo = await inspectExec(info.exec_id);
        const logs = await getExecLogs(info.exec_id);
        if (inspectInfo.State.Running) {
          setTimeout(checkLogs, 1000, info);
          setT(`state_${info.id}`, "running");
        }
        else {
          removeExec(info.exec_id);    // auto remove after getting logs
          setT(`state_${info.id}`, "exited");
        }
        currentLog = logs.lines;
        if (logWindow) {
          logWindow.setLog(currentLog);
        }
      }

      async function setInputPath() {
        const filepath = await showFileSave('1', '');
        console.log(filepath)
      }

      async function setSourceCode() {
        const res = await showFileUploadDialogBox();
        if (sourceUploadInfo) {
          if (sourceUploadInfo.success) {
            removeUploadItem(sourceUploadInfo.upload_id);
          }
        }
        sourceUploadInfo = res;
        setV("src_path", sourceUploadInfo.files[0]);
      }

      async function setCommandLine() {
        const command = await showInputDialogBox("커맨드 라인 입력", "입력");
        setV("command_line", command);
      }

      async function refreshImageList() {
        const imageList = await getExecImageList();

        const selectImages = document.getElementById("select_images");
        while (selectImages.length > 0) {
          selectImages.remove(0);
        }

        for (const im of imageList) {
          const option = document.createElement("option");
          option.text = im.RepoTags;
          selectImages.add(option);
        }
      }

      async function init() {
        const tab = createTab([
          {id: "new_exec", text: "새 실험/실행"},
          {id: "current_exec", text: "실행 중"},
          {id: "completed_exec", text: "실행 완료"}]);
        addE("tab_div", tab);

        refreshImageList();

        window.addEventListener("beforeunload", (e) => {
          if (sourceUploadInfo) {
            removeUploadItem(sourceUploadInfo.upload_id);
            console.log('remove:', sourceUploadInfo.upload_id)
          }
        });
      }
    </script>
  </head>
  <body>
    <LP-include-html src="bs-script.html"></LP-include-html>
    <LP-include-html src="topbar.html"></LP-include-html>

    <div class="container-fluid">
      <div class="row">
        <LP-include-html src="sidebar.html"></LP-include-html>
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
          <div class="p-3 bg-body-tertiary" style="width:100%;">
            <h2>실험/실행</h2>
            <div id="tab_div" class="my-2"></div>
            <div class="tab-content">
              <div class="tab-pane fade show active" id="new_exec" role="tabpanel">
                <div>
                  <h5 class="mt-2">기본정보</h5>
                  <div class="row mb-2">
                    <label for="input_exp_id" class="col-sm-2 col-form-label">실험 ID</label>
                    <div class="col-sm-7">
                      <input type="text" class="form-control" id="input_exp_id" value="">
                    </div>
                  </div>
                  <div class="row mb-2">
                    <label for="input_exec_id" class="col-sm-2 col-form-label">설명</label>
                    <div class="col-sm-7">
                      <textarea class="form-control" id="input_exec_desc" rows="3"></textarea>
                    </div>
                  </div>
                  <div class="row mb-2">
                    <label for="input_exec_id" class="col-sm-2 col-form-label">실행 ID</label>
                    <div class="col-sm-7">
                      <input type="text" class="form-control" id="input_exec_id" value="">
                    </div>
                    <div class="col-sm-2">
                      <button class="btn btn-outline-primary">자동 생성</button>
                    </div>
                  </div>

                  <h5 class="mt-2">환경</h5>
                  <div class="row mb-2">
                    <label for="select_images" class="col-sm-2 col-form-label">이미지</label>
                    <div class="col-sm-7">
                      <select class="form-select" id="select_images" aria-label="Default select example">
                      </select>
                    </div>
                    <div class="col-sm-2">
                      <button class="btn btn-outline-primary">새로 생성</button>
                    </div>
                  </div>

                  <div class="row mb-2">
                    <label for="input_data_path" class="col-sm-2 col-form-label">입력 데이터 경로</label>
                    <div class="col-sm-7">
                      <input type="text" class="form-control" id="input_data_path" value="" readonly>
                    </div>
                    <div class="col-sm-2">
                      <button class="btn btn-outline-primary" onclick="setInputPath()">설정</button>
                    </div>
                  </div>

                  <div class="row mb-2">
                    <label for="output_data_path" class="col-sm-2 col-form-label">출력 데이터 경로</label>
                    <div class="col-sm-7">
                      <input type="text" class="form-control" id="output_data_path" value="" readonly>
                    </div>
                    <div class="col-sm-2">
                      <button class="btn btn-outline-primary">설정</button>
                    </div>
                  </div>

                  <h5 class="mt-2">실행 코드</h5>
                  <div class="row mb-2">
                    <label for="src_path" class="col-sm-2 col-form-label">소스 코드</label>
                    <div class="col-sm-7">
                      <input type="text" class="form-control" id="src_path" value="" readonly>
                    </div>
                    <div class="col-sm-2">
                      <button class="btn btn-outline-primary" onclick="setSourceCode()">설정</button>
                    </div>
                  </div>

                  <div class="row mb-2">
                    <label for="command_line" class="col-sm-2 col-form-label">커맨드 라인</label>
                    <div class="col-sm-7">
                      <input type="text" class="form-control" id="command_line" value="python main.py" readonly onclick="setCommandLine()">
                    </div>
                    <div class="col-sm-2">
                      <button class="btn btn-outline-primary" onclick="setCommandLine()">설정</button>
                    </div>
                  </div>

                  <h5 class="mt-2">사용 자원</h5>
                  <div class="row mb-2">
                    <div class="col-sm-2">
                      GPU
                    </div>
                    <div class="col-sm-7">
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="resource" id="resource_cpu_only">
                        <label class="form-check-label" for="resource_cpu_only">
                          CPU 단독
                        </label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="resource" id="resource_gpu" checked>
                        <label class="form-check-label" for="resource_gpu">
                          GPU 사용
                        </label>
                      </div>
                    </div>
                  </div>

                </div>

                <div class="text-center">
                  <button type="button" class="btn btn-primary p-4" style="width: 34%" onclick="createExecution()">실행</button>
                </div>
              </div>

              <div class="tab-pane fade" id="current_exec" role="tabpanel" >
                <div class="list-group" id="exec_list"></div>
              </div>

              <div class="tab-pane fade" id="completed_exec" role="tabpanel">
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>
    <LP-include-html src="fileupload.html"></LP-include-html>
    <LP-include-html src="input.html"></LP-include-html>
    <LP-include-html src="logview.html"></LP-include-html>
    <LP-include-html src="filesave.html"></LP-include-html>
    <LP-include-html src="messagebox.html"></LP-include-html>
    <script>init();</script>
  </body>
</html>


